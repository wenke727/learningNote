# Geopandas

## å­¦ä¹ èµ„æº

- [Geopandas docs](https://geopandas.org/docs.html)
- [DataScienceStudyNotes](https://github.com/CNFeffery/DataScienceStudyNotes)
- [ ] [æ•°æ®ç»“æ„ç¯‡](https://www.cnblogs.com/feffery/p/11898190.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD74%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AF%87)
- [x] [åæ ‡å‚è€ƒç³»ç¯‡](https://www.cnblogs.com/feffery/p/12285828.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD75%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E5%9D%90%E6%A0%87%E5%8F%82%E8%80%83%E7%B3%BB%E7%AF%87)
- [ ] [æ–‡ä»¶IO](https://www.cnblogs.com/feffery/p/12301966.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD77%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E6%96%87%E4%BB%B6IO)
- [x] [ç©ºé—´è®¡ç®—ç¯‡ï¼ˆä¸Šï¼‰](https://www.cnblogs.com/feffery/p/12909284.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD84%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E7%A9%BA%E9%97%B4%E8%AE%A1%E7%AE%97%E7%AF%87%EF%BC%88%E4%B8%8A%EF%BC%89)
- [x] [ç©ºé—´è®¡ç®—ç¯‡ï¼ˆä¸‹ï¼‰](https://www.cnblogs.com/feffery/p/13129271.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD88%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E7%A9%BA%E9%97%B4%E8%AE%A1%E7%AE%97%E7%AF%87%EF%BC%88%E4%B8%8B%EF%BC%89)
- [ ] [åŸºç¡€å¯è§†åŒ–](https://www.cnblogs.com/feffery/p/12361421.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD78%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E5%9F%BA%E7%A1%80%E5%8F%AF%E8%A7%86%E5%8C%96)
- [ ] [geoplotç¯‡(ä¸Š)](https://www.cnblogs.com/feffery/p/12779150.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD82%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94geoplot%E7%AF%87(%E4%B8%8A))
- [ ] [geoplotç¯‡(ä¸‹)](https://www.cnblogs.com/feffery/p/12901334.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD83%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94geoplot%E7%AF%87(%E4%B8%8B))
- [ ] [æ·±å…¥æµ…å‡ºåˆ†å±‚è®¾è‰²](https://www.cnblogs.com/feffery/p/12381322.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD79%EF%BC%89%E5%9F%BA%E4%BA%8Egeopandas%E7%9A%84%E7%A9%BA%E9%97%B4%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E2%80%94%E2%80%94%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA%E5%88%86%E5%B1%82%E8%AE%BE%E8%89%B2)
- [ ] [geopandas&geoplotè¿‘æœŸé‡è¦æ›´æ–°](https://www.cnblogs.com/feffery/p/13233271.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD89%EF%BC%89geopandas%26geoplot%E8%BF%91%E6%9C%9F%E9%87%8D%E8%A6%81%E6%9B%B4%E6%96%B0)
- [x] [åˆ©ç”¨geopandasä¸PostGISè¿›è¡Œäº¤äº’](https://www.cnblogs.com/feffery/p/13468203.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD93%EF%BC%89%E5%88%A9%E7%94%A8geopandas%E4%B8%8EPostGIS%E8%BF%9B%E8%A1%8C%E4%BA%A4%E4%BA%92)
- [x] [åœ¨geopandasä¸­å åŠ åœ¨çº¿åœ°å›¾](https://www.cnblogs.com/feffery/p/13763601.html)ã€€:airplane:[ä»“åº“è·¯å¾„](https://github.com/CNFeffery/DataScienceStudyNotes/tree/master/%EF%BC%88%E6%95%B0%E6%8D%AE%E7%A7%91%E5%AD%A6%E5%AD%A6%E4%B9%A0%E6%89%8B%E6%9C%AD96%EF%BC%89%E5%9C%A8geopandas%E4%B8%AD%E5%8F%A0%E5%8A%A0%E5%9C%A8%E7%BA%BF%E5%9C%B0%E5%9B%BE)

----

## åŸºç¡€æ“ä½œ

### è®¾ç½®CRS
  
å¸¸ç”¨CRSæ ¼å¼ï¼š

- Proj4

  ```python
  +proj=utm +zone=11 +datum=WGS84 +units=m +no_defs +ellps=WGS84 +towgs84=0,0,0
  ```

- [EPSGç¼–ç ](http://spatialreference.org/ref/epsg/)
  - 4326:  WGS84
  - 3857: the Spherical Mercator projection (EPSG:3857)

CRSè®¾ç½®ä¸å†æŠ•å½±

  ``` python
  df_edges.set_crs('EPSG:4326', inplace=True)

  from shapely import geometry
  import matplotlib.pyplot as plt
  import geopandas as gpd

  world = gpd.read_file(gpd.datasets.get_path('naturalearth_lowres'))
  china = world.loc[world['name'].isin(['China', 'Taiwan'])]

  cq = gpd.GeoSeries([geometry.Point([106.561203, 29.558078])], crs='EPSG:4326')
  ```

### [sindex](https://geopandas.org/docs/reference/api/geopandas.GeoDataFrame.sindex.html?highlight=sindex)

  ``` python
  georadius = georadius*dis_factor
  boxes = traj.geometry.apply(lambda i: box(i.x-georadius, i.y-georadius,i.x+georadius, i.y+georadius))
  df_candidates = boxes.apply(lambda x: edges.sindex.query(x, predicate='intersects')).explode()

  # TUTORIAL
  from shapely.geometry import box
  s = geopandas.GeoSeries(geopandas.points_from_xy(range(5), range(5)))
  s.sindex.query(box(1, 1, 3, 3))
  """
  s:
  0    POINT (0.00000 0.00000)
  1    POINT (1.00000 1.00000)
  2    POINT (2.00000 2.00000)
  3    POINT (3.00000 3.00000)
  4    POINT (4.00000 4.00000)

  # output: array([1, 2, 3])
  """
  ```

### [å’ŒPostGISäº¤äº’](https://www.cnblogs.com/feffery/p/13468203.html)

PostGISä½œä¸ºpostgresqlé’ˆå¯¹åœ°ç†ç©ºé—´æ•°æ®çš„æ‹“å±•åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬æœ‰æ•ˆç®¡ç†å’Œå›ºåŒ–ç©ºé—´çŸ¢é‡æ•°æ®ï¼Œä»¥åŠå¼€å±•ç©ºé—´æ•°æ®åˆ†æï¼Œè€Œgeopandasä½œä¸ºPythonç”Ÿæ€ä¸­ä¼˜ç§€çš„ç©ºé—´æ•°æ®åˆ†æå¤„ç†å·¥å…·ï¼Œè‡ªç„¶åœ¨ä¸PostGISè¿›è¡Œäº¤äº’æ–¹é¢å¼€å‘äº†ç›¸åº”çš„åŠŸèƒ½ã€‚

``` python
import geopandas as gpd
from sqlalchemy import create_engine
ENGINE = create_engine('postgresql://postgres:123456@192.168.135.16:5432/road_network')

"""
å†™å…¥æ•°æ®
  name: å­—ç¬¦å‹ï¼Œç”¨äºæŒ‡å®šæ¨é€åˆ°PostGISåçš„è¡¨åç§°
  con: sqlalchemy.engine.Engineå¯¹è±¡ï¼Œç”¨äºå»ºç«‹ä¸æ•°æ®åº“çš„è¿æ¥
  if_exists: å­—ç¬¦å‹ï¼Œç”¨äºæŒ‡å®šå½“æ•°æ®åº“ä¸­å·²å­˜åœ¨åŒåè¡¨æ—¶çš„ç›¸åº”ç­–ç•¥ï¼Œ'fail'è¡¨ç¤ºæŠ›å‡ºé”™è¯¯ï¼Œ'replace'æŒ‡æ›¿æ¢ï¼Œ'append'æŒ‡å‘åŸè¡¨è¿½åŠ ï¼Œé»˜è®¤ä¸ºfail
  schema: å­—ç¬¦å‹ï¼Œç”¨äºæŒ‡å®šschemaï¼Œé»˜è®¤ä¸º'public'
  index: boolå‹ï¼Œç”¨äºæŒ‡å®šæ˜¯å¦ä¿ç•™indexä¿¡æ¯
  index_label: å­—ç¬¦å‹æˆ–åºåˆ—ï¼Œå½“indexè¢«è®¾ç½®ä¸ºTrueæ—¶ä¸ºindexä¿¡æ¯æŒ‡å®šå­—æ®µåç§°
"""
df_panos.to_postgis( name='panos', con=engine, if_exists='replace' )

"""
è¯»å–æ•°æ®:
  sql: å­—ç¬¦å‹ï¼Œå¯¹åº”ä»ç©ºé—´æ•°æ®åº“ä¸­æå–æ•°æ®çš„SQLè¯­å¥
  con: åŒto_postgis()
  geom_col: å­—ç¬¦å‹ï¼Œç”¨äºæŒ‡å®šå°†å“ªä¸€åˆ—ä½œä¸ºGeoDataFrameçš„çŸ¢é‡åˆ—
  crs: ç”¨äºæŒ‡å®šåæ ‡å‚è€ƒç³»ï¼ŒåŒGeoDataFrameçš„åæ ‡å‚è€ƒç³»è®¾å®šæ–¹å¼
  index_col: å­—ç¬¦å‹æˆ–åˆ—è¡¨ï¼Œç”¨äºæŒ‡å®šå°†å“ªäº›åˆ—ä½œä¸ºç´¢å¼•
  parse_dates: åˆ—è¡¨ï¼Œç”¨äºé¢„è§£ææ—¶é—´ç±»å‹æ•°æ®
"""
gpd.read_postgis( f"SELECT * FROM {matching[feature]} ", geom_col='geometry', con=ENGINE )
```

## [ç»˜å›¾](https://www.cnblogs.com/feffery/p/12361421.html)

### åŸºç¡€å¯è§†åŒ–

- GeoSeries

  ```python
  """
  figsize: ä¼ å…¥(å®½åº¦, é«˜åº¦)å½¢å¼çš„å…ƒç»„æˆ–åˆ—è¡¨ï¼Œç”¨äºæ§åˆ¶ç»˜åˆ¶å‡ºå›¾åƒçš„å®½åº¦å’Œé«˜åº¦ï¼Œå•ä½å‡ä¸ºè‹±å¯¸
  facecolor: è®¾ç½®å‡ ä½•å¯¹è±¡çš„å¡«å……è‰²ï¼Œå¯æ¥å—é¢œè‰²åç§°å’Œåå…­è¿›åˆ¶è‰²å½©ï¼Œè®¾ç½®ä¸º'none'æ—¶ä¸å¡«å……é¢œè‰²
  edgecolor: è®¾ç½®å‡ ä½•å¯¹è±¡çš„è¾¹ç•Œè‰²ï¼Œå¯¹é¢æ•°æ®å’Œç‚¹æ•°æ®æ•ˆæœè¾ƒä¸ºæ˜æ˜¾ï¼Œä¸å»ºè®®å¯¹çº¿æ•°æ®è®¾ç½®è¯¥å‚æ•°ï¼Œä¼ å…¥æ ¼å¼åŒfacecolor
  linewidth: è®¾ç½®å‡ ä½•å¯¹è±¡è¾¹ç•Œå®½åº¦ï¼Œå¯¹é¢æ•°æ®å’Œç‚¹æ•°æ®æ•ˆæœè¾ƒä¸ºæ˜æ˜¾ï¼Œä¸å»ºè®®å¯¹çº¿æ•°æ®è®¾ç½®è¯¥å‚æ•°
  linestyle: å­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè®¾ç½®å‡ ä½•å¯¹è±¡è¾¹ç•ŒåŠçº¿æ•°æ®çš„çº¿å‹
  markersize: è®¾ç½®ç‚¹æ•°æ®çš„å¤§å°
  marker: å­—ç¬¦ä¸²ç±»å‹ï¼Œç”¨äºè®¾ç½®ç‚¹æ•°æ®çš„å½¢çŠ¶
  alpha: è®¾ç½®å¯¹åº”å‡ ä½•å¯¹è±¡å…¨å±€çš„è‰²å½©é€æ˜åº¦ï¼Œ0-1ï¼Œè¶Šå¤§è¶Šä¸é€æ˜
  label: é€‚ç”¨äºçº¯ç²¹çš„çº¿æ•°æ®æˆ–ç‚¹æ•°æ®ï¼Œåœ¨éœ€è¦æ·»åŠ å›¾ä¾‹æ—¶é€‚ç”¨ï¼Œç”¨ä½œå„ä¸ªå¯¹è±¡åœ¨å›¾ä¾‹ä¸­æ˜¾ç¤ºçš„åç§°
  hatch: å­—ç¬¦å‹ï¼Œç”¨äºè®¾ç½®é¢æ•°æ®å†…éƒ¨çš„å¡«å……çº¿æ ·å¼ä¸‹æ–‡çš„ä¾‹å­ä¸­å°†å…·ä½“ä¸¾ä¾‹è¯´æ˜
  ax: matplotlibåæ ‡è½´å¯¹è±¡ï¼Œå¦‚æœéœ€è¦åœ¨åŒä¸€ä¸ªåæ ‡è½´å†…å åŠ å¤šä¸ªå›¾å±‚å°±éœ€è¦ç”¨è¿™ä¸ªå‚æ•°ä¼ å…¥å…ˆå‰å¾…å åŠ çš„ax
  """
  ```

- GeoDataFrame

  ``` python
  """
  column: ç”¨äºæŒ‡å®šæ˜ å°„åœ°å›¾è§†è§‰å…ƒç´ çš„æ•°å€¼ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯å¯¹åº”GeoDataFrameçš„åˆ—åï¼Œæˆ–æ˜¯ç›´æ¥ä¼ å…¥ä¸å‡ ä½•å¯¹è±¡ä¸€ä¸€å¯¹åº”å¾—æ•°å€¼åºåˆ—ï¼Œé»˜è®¤ä¸ºNone
  cmap: ä¼ å…¥æ˜ å°„è§†è§‰å…ƒç´ æ—¶çš„è‰²å½©æ–¹æ¡ˆï¼Œå…·ä½“ä½¿ç”¨æ–¹å¼ä¸‹æ–‡ä¸­ä¼šåšè¯¦ç»†ä»‹ç»
  categorical: boolå‹ï¼ŒTrueè¡¨ç¤ºæŒ‡å®šæ˜ å°„ç›®æ ‡åˆ—é‡‡å–ç¦»æ•£è¡¨ç¤ºï¼Œå¯¹äºæ•°å€¼å‹çš„åˆ—æœ‰æ„ä¹‰ï¼Œå½“å¯¹åº”ç›®æ ‡åˆ—ä¸ºç±»åˆ«å‹æ—¶è‡ªåŠ¨å˜ä¸ºTrue
  legend: boolå‹ï¼Œä¸ºTrueæ—¶ä¼šä¸ºåœ°å›¾æ·»åŠ å›¾ä¾‹
  scheme: strå‹ï¼Œç”¨äºæŒ‡å®šåœ°åŒºåˆ†å¸ƒå›¾åˆ†å±‚è®¾è‰²çš„æ•°å€¼åˆ’åˆ†æ–¹æ¡ˆï¼Œä¸‹æ–‡ä¸­ä¼šåšè¯¦ç»†ä»‹ç»
  k: intå‹ï¼Œç”¨äºæŒ‡å®šåˆ†å±‚è®¾è‰²çš„è‰²é˜¶æ•°é‡
  vmin: Noneæˆ–floatï¼Œç”¨äºæŒ‡å®šåˆ†å±‚è®¾è‰²çš„æ•°å€¼èŒƒå›´ä¸‹é™ï¼Œé»˜è®¤ä¸ºNoneå³ä»¥å¯¹åº”æ•°æ®ä¸­çš„æœ€å°å€¼ä¸ºä¸‹é™
  vmax: Noneæˆ–floatï¼Œç”¨äºæŒ‡å®šåˆ†å±‚è®¾è‰²çš„æ•°å€¼èŒƒå›´ä¸Šé™ï¼Œé»˜è®¤ä¸ºNoneå³ä»¥å¯¹åº”æ•°æ®ä¸­çš„æœ€å¤§å€¼ä¸ºä¸Šé™
  legend_kwds: å­—å…¸å‹ï¼Œä¼ å…¥ä¸å›¾ä¾‹ç›¸å…³çš„ä¸ªæ€§åŒ–å‚æ•°
  classification_kwds: å­—å…¸å‹ï¼Œä¼ å…¥ä¸åˆ†å±‚è®¾è‰²ç›¸å…³çš„ä¸ªæ€§åŒ–å‚æ•°
  missing_kwds: å­—å…¸å‹ï¼Œä¼ å…¥ä¸ç¼ºå¤±å€¼å¤„ç†ç›¸å…³çš„ä¸ªæ€§åŒ–å‚æ•°ï¼Œç”¨äºå¯¹ç¼ºå¤±å€¼éƒ¨åˆ†çš„è§†è§‰æ˜ å°„åšä¸ªæ€§åŒ–è®¾ç½®
  """
  ```

### [å åŠ åœ¨çº¿åœ°å›¾](https://www.cnblogs.com/feffery/p/13763601.html)

[contextily: context geo tiles in Python](https://contextily.readthedocs.io/en/latest/index.html)

å…¶ä»–æ ·å¼å¯å‚è€ƒ:

- [ç½‘é¡µ](https://www.cnblogs.com/feffery/p/13763601.html);
- [é«˜å¾·è°·æ­Œè…¾è®¯å¤©åœ°å›¾åœ°å›¾ç“¦ç‰‡url](https://blog.csdn.net/sinat_41310868/article/details/105959659?utm_source=app&app_version=4.11.0&code=app_1562916241&uLinkId=usr1mkqgl919blen)

ç»˜å›¾æ­¥éª¤

- æ­£å¸¸è¯»å…¥çŸ¢é‡æ•°æ®åï¼Œä¸€å®šè¦å…ˆå˜æ¢æŠ•å½±ä¸ºwebå¢¨å¡æ‰˜å³`EPSG:3857`ï¼Œ
- æ¥ç€æ­£å¸¸ç»˜å›¾
- æœ€å, axå¯¹è±¡ä¼ å…¥ctx.add_basemapä¸­ï¼Œå¹¶æ·»åŠ äº†å‚æ•°sourceä»£è¡¨å¯¹åº”åœ¨çº¿ç“¦ç‰‡åœ°å›¾çš„urlï¼Œå‚æ•°zoomæ¥æ§åˆ¶åœ°å›¾ç¼©æ”¾ç²¾åº¦çº§åˆ«ã€‚

``` python
import geopandas as gpd
import contextily as ctx
import matplotlib.pyplot as plt

cq = gpd.read_file('é‡åº†å¸‚.geojson').to_crs('EPSG:3857')

fig, ax = plt.subplots(figsize=(10, 10))
ax = cq.plot(ax=ax, alpha=0.1, edgecolor='k')
ax.axis('off')

ctx.add_basemap(ax, 
                source='https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
                zoom=8)

fig.savefig('å›¾2 å åŠ åœ¨çº¿åœ°å›¾ç¤ºä¾‹.png', pad_inches=0, bbox_inches='tight', dpi=300)
```

----

## [ç©ºé—´è®¡ç®—](https://www.cnblogs.com/feffery/p/12909284.html)

### æ„é€ æ€§æ–¹æ³•

- buffer
  geopandasä¸­çš„buffer()æ–¹æ³•æºäºshapelyï¼Œç”¨äºç¼“å†²åŒºçš„åˆ›å»º

- total_bounds
  è¿”å›ä¾æ¬¡è®°å½•äº†æ•´åˆ—çŸ¢é‡æ•°æ®æ‰€åœ¨æœ€å°çŸ©å½¢åŒºåŸŸå·¦ä¸‹è§’xã€å·¦ä¸‹è§’yã€å³ä¸Šè§’xä»¥åŠå³ä¸Šè§’yçš„numpyæ•°ç»„

- unary_union
  é€šè¿‡unary_unionå±æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€æ•´åˆ—çŸ¢é‡åˆå¹¶ä¸ºå•ç‹¬çš„ä¸€ä¸ªshapelyçŸ¢é‡å¯¹è±¡ï¼Œä»è€Œæ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œä¸€äº›å…¶ä»–çš„æ“ä½œ

- [simplify](https://www.cnblogs.com/feffery/p/12909284.html)
  geopandasä¸­æ²¿ç”¨shapelyä¸­çš„simplify()æ–¹æ³•ï¼Œå¸®åŠ©æˆ‘ä»¬å¯¹è¿‡äºå¤æ‚çš„çº¿å’Œé¢è¿›è¡Œç®€åŒ–ï¼Œå’ŒQGISä¸­ç®€åŒ–çŸ¢é‡çš„æ–¹æ³•ä¸€æ ·ï¼Œsimplify()ä½¿ç”¨äº†ç§‘å­¦çš„Douglas-Peuckerç®—æ³•ï¼ŒåŸºäºé¢„å…ˆè®¾å®šçš„é˜ˆå€¼ğœ–ï¼Œåœ¨é€’å½’åˆ¤æ–­çš„è¿‡ç¨‹ä¸­åˆ æ‰æ‰€æœ‰å°äºğœ–çš„ç‚¹

    ```python
    import numpy as np
    import matplotlib.patches as mpatches

    np.random.seed(10) # å›ºå®šéšæœºæ•°ç§å­
    # åˆ›å»ºçº¿
    line = shapely.geometry.LineString([(_, np.random.uniform(-1, 1)) for _ in range(10)])
    # ç»˜åˆ¶ç®€åŒ–å‰
    ax = gpd.GeoSeries([line]).plot(color='red')
    # ç»˜åˆ¶ç®€åŒ–å
    ax = gpd.GeoSeries([line]).simplify(tolerance=0.5).plot(color='blue', 
                                                            ax=ax,
                                                            linestyle='--')

    # åˆ¶ä½œå›¾ä¾‹æ˜ å°„å¯¹è±¡åˆ—è¡¨
    LegendElement = [plt.Line2D([], [], color='red', label='ç®€åŒ–å‰'),
                    plt.Line2D([], [], color='blue', linestyle='--', label='ç®€åŒ–å')]

    # å°†åˆ¶ä½œå¥½çš„å›¾ä¾‹æ˜ å°„å¯¹è±¡åˆ—è¡¨å¯¼å…¥legend()ä¸­ï¼Œå¹¶é…ç½®ç›¸å…³å‚æ•°
    ax.legend(handles = LegendElement, 
            loc='lower left', 
            fontsize=10)

    ax.set_ylim((-2.5, 1))
    ax.axis('off')
    plt.savefig('å›¾7.png', dpi=300, bbox_inches='tight', pad_inches=0)
    ```

### ä»¿å°„å˜æ¢

- rotate()
  å¯¹çŸ¢é‡åˆ—ä¸­çš„æ¯ä¸ªè¦ç´ åˆ†åˆ«è¿›è¡Œæ—‹è½¬æ“ä½œ
- scale()
  ç”¨äºå¯¹çŸ¢é‡å¯¹è±¡è¿›è¡Œå„ä¸ªç»´åº¦ä¸Šçš„æ”¾ç¼©æ“ä½œ
- translate()
  ç”¨äºå®ç°çŸ¢é‡å¯¹è±¡çš„å¹³ç§»æ“ä½œï¼Œå…¶ä¸»è¦å‚æ•°æœ‰xoffå’Œyoffï¼Œåˆ†åˆ«æ§åˆ¶åœ¨xç»´åº¦å’Œyç»´åº¦ä¸Šçš„å¹³ç§»è·ç¦»ï¼ˆä¸å¯¹åº”çš„æŠ•å½±å•ä½ä¿æŒä¸€è‡´ï¼‰

### å åŠ åˆ†æ

å¯¹ä¸¤ä¸ªGeoDataFrameä¸­å…¨éƒ¨çš„çŸ¢é‡å¯¹è±¡ä¸¤ä¸¤ä¹‹é—´è¿›è¡ŒåŸºäºé›†åˆå…³ç³»çš„å åŠ åˆ†æ
å‚æ•°ï¼š
> df1ï¼šGeoDataFrameï¼Œä½œä¸ºè¾“å…¥çš„ç¬¬ä¸€ä¸ªçŸ¢é‡æ•°æ®é›†
df2ï¼šGeoDataFrameï¼Œä½œä¸ºè¾“å…¥çš„ç¬¬äºŒä¸ªçŸ¢é‡æ•°æ®é›†
howï¼šå­—ç¬¦å‹ï¼Œç”¨äºå£°æ˜ç©ºé—´å åŠ çš„ç±»å‹ï¼Œæœ‰'intersection'ï¼Œ'union'ã€'symmetric_difference'ã€'difference'ï¼Œä»¥åŠé¢å¤–çš„'identity'ï¼Œä»–ä»¬ä¹‹é—´çš„åŒºåˆ«ä¸‹æ–‡ä¼šè¿›è¡Œè¯¦ç»†ä»‹ç»
keep_geom_typeï¼šboolå‹ï¼Œå½“df1ä¸df2çŸ¢é‡ç±»å‹ä¸åŒæ—¶ï¼ˆè­¬å¦‚é¢ä¸çº¿æ•°æ®ä¹‹é—´è¿›è¡Œå åŠ åˆ†æï¼‰ï¼Œç”¨äºå†³å®šåœ¨å åŠ åˆ†æäº§ç”Ÿç»“æœä¸­ï¼Œæ˜¯å¦åªä¿ç•™ä¸df1çŸ¢é‡ç±»å‹ç›¸åŒçš„è®°å½•ï¼Œé»˜è®¤ä¸ºTrue

![å åŠ åˆ†ææ•ˆæœ](https://img2020.cnblogs.com/blog/1344061/202005/1344061-20200521180921642-1658583538.png)

ç¤ºä¾‹ï¼š

```python
polygon1 = gpd.GeoDataFrame({
    'value1': [1, 2],
    'geometry': [shapely.geometry.Polygon([(1, 0), (3, 0), (3, 10), (1, 10)]),
                 shapely.geometry.Polygon([(6, 0), (8, 0), (8, 10), (6, 10)])]
})

polygon2 = gpd.GeoDataFrame({
    'value2': [3, 4],
    'geometry': [shapely.geometry.Polygon([(-1, 3), (-1, 5), (10, 5), (10, 3)]),
                 shapely.geometry.Polygon([(-1, 6), (-1, 8), (10, 8), (10, 6)])]
})

ax = polygon1.plot(color='red', alpha=0.4)
ax = polygon2.plot(color='grey', alpha=0.4, ax=ax)
ax.axis('off')
plt.savefig('å›¾14.png', dpi=300, bbox_inches='tight', pad_inches=0)

overlay_result = gpd.overlay(df1=polygon1, df2=polygon2, how='union')
overlay_result

```

### ç©ºé—´èåˆå’Œæ‹†åˆ†

- dissolve()
  ç”¨äºå¯¹çŸ¢é‡æ•°æ®è¿›è¡Œèåˆï¼Œå¯ä»¥ç†è§£ä¸ºå¯¹çŸ¢é‡æ•°æ®è¿›è¡Œgroupby+aggæ“ä½œï¼Œå³æŒ‡å®šçš„å•ä¸ªæˆ–å¤šä¸ªå­—æ®µå€¼ç›¸ç­‰çš„åˆ†åˆ°ä¸€ç»„ï¼Œå¯¹éçŸ¢é‡å­—æ®µè¿›è¡ŒæŒ‡å®šè§„åˆ™çš„èšåˆè®¡ç®—ï¼Œå¯¹çŸ¢é‡åˆ—è¿›è¡Œèåˆ
- explode()
  åŠŸèƒ½ä¸dissolve()ç›¸åï¼Œç”¨äºå°†Multi-xxxæˆ–Geometry-Collectionç±»å‹çš„æ•°æ®ä»ä¸€è¡Œæ‹†åˆ†åˆ°å¤šè¡Œï¼Œå¦‚ä¸‹é¢çš„ä¾‹å­ï¼ŒéçŸ¢é‡å­—æ®µä¼šè‡ªåŠ¨å¡«å……åˆ°æ¯ä¸€è¡Œ

### [ç©ºé—´è¿æ¥](https://www.cnblogs.com/feffery/p/13129271.html)

ç±»æ¯”å¸¸è§„è¡¨æ ¼æ•°æ®çš„è¿æ¥æ“ä½œï¼Œåœ¨ç©ºé—´æ•°æ®åˆ†æä¸­ä¹Ÿå­˜åœ¨ç±»ä¼¼è¡¨è¿æ¥çš„æ“ä½œï¼Œè­¬å¦‚æˆ‘ä»¬æ‰‹å¤´æœ‰ä¸€å¼ åŒ…å«è®¾æ–½ç‚¹æ•°æ®çš„çŸ¢é‡è¡¨ï¼Œä»¥åŠå¦ä¸€å¼ åŒ…å«è¡Œæ”¿åŒºåˆ’é¢æ•°æ®çš„çŸ¢é‡è¡¨ï¼Œå½“æˆ‘ä»¬æƒ³è¦é€šè¿‡æŸäº›æ“ä½œæ¥ç»Ÿè®¡å‡ºæ¯ä¸ªè¡Œæ”¿åŒºåˆ’é¢å†…éƒ¨çš„è®¾æ–½ç‚¹ä¿¡æ¯æ—¶ï¼Œç©ºé—´è¿æ¥å°±å¯ä»¥éå¸¸æ–¹ä¾¿å¿«æ·åœ°å®ç°è¿™ç±»éœ€æ±‚ã€‚
è€Œç©ºé—´è¿æ¥ä¸åŒäºå¸¸è§„è¡¨è¿æ¥ï¼Œå…¶åˆå¹¶åŒä¸€è¡Œçš„ä¾æ®ä¸æ˜¯æ£€æŸ¥æŒ‡å®šçš„åˆ—æ•°å€¼æ˜¯å¦ç›¸ç­‰ï¼Œè€Œæ˜¯åŸºäºä¸åŒçŸ¢é‡è¡¨å…¶çŸ¢é‡åˆ—ä¹‹é—´çš„ç©ºé—´æ‹“æ‰‘å…³ç³»ï¼Œè­¬å¦‚ç›¸äº¤ã€åŒ…å«ç­‰

- å‚æ•°
  >left_df: GeoDataFrameï¼Œä¼ å…¥ç©ºé—´è¿æ¥å¯¹åº”çš„å·¦è¡¨
  right_df: GeoDataFrameï¼Œä¼ å…¥ç©ºé—´è¿æ¥å¯¹åº”çš„å³è¡¨
  how: å­—ç¬¦å‹ï¼Œç”¨äºå†³å®šè¿æ¥æ–¹å¼ï¼Œ`inner`è¡¨ç¤ºå†…è¿æ¥ï¼Œä¸”è¿æ¥ç»“æœè¡¨ä¸­çš„çŸ¢é‡åˆ—æ¥è‡ªå·¦è¡¨ï¼›`left`è¡¨ç¤ºå·¦è¿æ¥ï¼Œä¸”ç»“æœè¡¨ä¸­çš„çŸ¢é‡åˆ—æ¥è‡ªå·¦è¡¨ï¼›`right`è¡¨ç¤ºå³è¿æ¥ï¼Œæœ€ç»ˆç»“æœè¡¨ä¸­çš„çŸ¢é‡åˆ—æ¥è‡ªå³è¡¨
  op: å­—ç¬¦å‹ï¼Œç”¨äºè®¾å®šæ‹“æ‰‘åˆ¤æ–­çš„è§„åˆ™ï¼Œ`intersects`ä»£è¡¨ç›¸äº¤ï¼Œå³å‡ ä½•å¯¹è±¡ä¹‹é—´å­˜åœ¨å…±æœ‰çš„è¾¹æˆ–å†…éƒ¨ç‚¹ï¼›`contains`ä»£è¡¨åŒ…å«ï¼Œå³ä¸€ä¸ªå‡ ä½•å¯¹è±¡è‡³å°‘æœ‰ä¸€ä¸ªç‚¹ä½äºå¦ä¸€ä¸ªå‡ ä½•å¯¹è±¡å†…éƒ¨ï¼Œä¸”å…¶æœ¬èº«æ²¡æœ‰ä»»ä½•ç‚¹è½åœ¨å¦ä¸€ä¸ªç»“å‡ ä½•å¯¹è±¡çš„å¤–éƒ¨ï¼›`within`è¡¨ç¤ºåœ¨å†…éƒ¨ï¼Œæ˜¯'contains'çš„ç›¸åæƒ…å†µï¼Œå³å·¦è¡¨è¢«å³è¡¨çŸ¢é‡'contains'
  lsuffix: å­—ç¬¦å‹ï¼Œä»£è¡¨å½“å·¦å³è¡¨è¿æ¥ä¹‹åå­˜åœ¨é‡ååˆ—æ—¶ï¼Œä¸ºå·¦è¡¨é‡åçš„åˆ—æ·»åŠ çš„åç¼€ï¼Œé»˜è®¤ä¸º'left'
  rsuffix: å­—ç¬¦å‹ï¼Œæ„ä¹‰ç±»ä¼¼lsuffixï¼Œé»˜è®¤ä¸º'right'
- æ¡ˆä¾‹

``` python
path_set = PathSet(cache_folder='/home/pcl/traffic/GBA_tranportation/cache', file_name='wkt_step')
df_path  = path_set.convert_to_gdf()
shenzhen_boundary = gpd.read_file('../input/ShenzhenBoundary_wgs_citylevel.geojson')

df_path = gpd.sjoin(df_path, shenzhen_boundary, op='within')

# another
gpd.sjoin(left_df=Berlin,
        right_df=Berlin_transport.query("fclass=='bus_stop'"),
        op='intersects') \
  .groupby('Gemeinde_n') \
  .size()
```

### [ç©ºé—´è£åˆ‡](https://www.cnblogs.com/feffery/p/13129271.html)

åœ¨ç©ºé—´æ•°æ®åˆ†æä¸­ï¼Œè£åˆ‡ä¹Ÿæ˜¯éå¸¸å¸¸ç”¨çš„æ“ä½œï¼Œè­¬å¦‚æˆ‘ä»¬æƒ³è¦è·å–æŸä¸ªå…¬äº¤ç«™å‘¨å›´500ç±³åŠå¾„å†…éƒ¨çš„è·¯ç½‘çŸ¢é‡ï¼Œå°±å¯ä»¥ä½¿ç”¨åˆ°è£åˆ‡

- å‚æ•°
  >gdf: GeoDataFrameæˆ–GeoSeriesï¼Œä»£è¡¨å°†è¦è¢«è£åˆ‡çš„çŸ¢é‡æ•°æ®é›†
  mask: GeoDataFrameã€GeoSeriesæˆ–shapelyä¸­çš„Polygonã€Multi-Polygonå¯¹è±¡ï¼Œä»£è¡¨è’™ç‰ˆçŸ¢é‡
  keep_geom_type: åŒå åŠ åˆ†æoverlayä¸­çš„åŒåå‚æ•°

- æ¡ˆä¾‹

  ``` python
  # è£åˆ‡æ‰€æœ‰å‡ºç§Ÿè½¦ç«™ç‚¹500ç±³ç¼“å†²åŒºå†…éƒ¨çš„è·¯ç½‘çº¿æ•°æ®
  taxi_station_500buffer_roads = gpd.clip(gdf=Berlin_footway, mask=taxi_station_500_buffer)
  ```

### æ‹“æ‰‘å…³ç³»æ£€æŸ¥

- intersects()ï¼šæ£€æŸ¥ç›¸äº¤å…³ç³»
- contains()ï¼šæ£€æŸ¥åŒ…å«å…³ç³»ï¼Œå³ä¸»ä½“çŸ¢é‡å®Œå…¨åŒ…è£¹ä½å¾…æ¯”è¾ƒçš„çŸ¢é‡ä¸”å®ƒä»¬çš„è¾¹ç•Œäº’ä¸æ¥è§¦ï¼Œè­¬å¦‚é¢å¯¹ç‚¹çš„åŒ…å«
- within()ï¼šæ£€æŸ¥ä¸»ä½“çŸ¢é‡æ˜¯å¦åœ¨å¾…æ£€æŸ¥çŸ¢é‡çš„å†…éƒ¨
- touches()ï¼šæ£€æŸ¥è§¦ç¢°å…³ç³»ï¼Œå³ä¸¤ä¸ªçŸ¢é‡ä¹‹é—´è‡³å°‘æœ‰ä¸€ä¸ª1ä¸ªå…¬å…±ç‚¹ï¼Œä½†å®ƒä»¬çš„å†…éƒ¨æ— ä»»ä½•ç›¸äº¤åŒºåŸŸ
- crosses()ï¼šæ£€æŸ¥äº¤å‰å…³ç³»ï¼Œå¸¸è§å¦‚çº¿ä¸çº¿ä¹‹é—´çš„äº¤å‰
- disjoint()ï¼šæ£€æŸ¥ä¸ç›¸äº¤å…³ç³»ï¼Œå³ä¸¤ä¸ªçŸ¢é‡ä¹‹é—´æ²¡æœ‰ä»»ä½•æ¥è§¦
- geom_equals()ï¼šæ£€æŸ¥æ˜¯å¦å®Œå…¨ç›¸åŒ
- overlaps()ï¼šæ£€æŸ¥é‡å å…³ç³»

----

## å¸¸ç”¨å‡½æ•°

``` python
import geopandas as gpd
from shapely.geometry import Point
from haversine import haversine, Unit

def gdf_to_geojson(gdf, fn):
    if 'geojson' not in fn:
        fn = f'{fn}.geojson'
    
    gdf.to_file(fn, driver="GeoJSON")

    return 


def df_query(df, key, value):
    return df.query( f"{key} == @value" )


def linestring_length(df:gpd.GeoDataFrame, add_to_att=False, key='length'):
    """caculate the length of LineString
    @return: pd:Series, length
    """
    if df.crs is None:
        df.set_crs(epsg=4326, inplace=True)
    dis =  df.to_crs('epsg:3395').length
    
    if add_to_att:
        df.loc[:, key] = dis
        return
    
    return dis


def coords_pair_dist(o, d, xy=True):
    if isinstance(o, Point) and isinstance(d, Point):
        return haversine((o.y, o.x), (d.y, d.x), unit=Unit.METERS)
    
    if (isinstance(o, tuple) and isinstance(d, tuple)) or \
       (isinstance(o, list) and isinstance(d, list)):
        if xy:
            return haversine(o[::-1], d[::-1], unit=Unit.METERS)
        else:
            return haversine(o, d, unit=Unit.METERS)
    
    return np.inf

```

----

## DEBUG

### 'LineString' object is not iterable

é€šè¿‡äºŒåˆ†æ³•å®šä½é—®é¢˜

``` python
def find_error_geom(df_edge):
    """Used to locate the problem: 'LineString' object is not iterable

    Args:
        df_edge ([type]): [description]

    Returns:
        [type]: [description]
    """
    start, end = 0, df_edge.shape[0]

    while start + 1 < end:
        mid = (start + end) // 2
        print(start ,": ", mid, ", ",end)
        flag = False
        try:
            df_edge.loc[start: mid].plot()
            plt.close()
            print( f"\t({start}, {mid}) pass" )
            start = mid
        except:
            end = mid

    try:
        df_edge.loc[[start]].plot()
        ans = end
    except:
        try:
            df_edge.loc[[end]].plot()
            ans = None
        except:
            ans = start

    return ans


error_id = find_error_geom(df_edge)
```

### Cannot interpret '<geopandas.array.GeometryDtype object at 0x7fa0244e4390>' as a data type

åŸå› ï¼šæƒ³å¤‡ä»½geometryï¼Œä½†å­˜å‚¨æ–‡ä»¶çš„æ—¶å€™ä¸å…è®¸ä¸¤ä¸ªå­—æ®µå­˜å‚¨geometry
è§£å†³æ–¹æ¡ˆï¼što_wkt()

``` python
df_edge.loc[:, 'geom_origin'] = df_edge.geometry.apply(lambda x: x.to_wkt())
```

### ValueError: Must have equal len keys and value when setting with an iterable

df.loc [1,'B']å¯ä»¥è¿”å›:

- å•ä¸ªå…ƒç´ (åœ¨è¿™ç§æƒ…å†µä¸‹,å½“1/'B'å…·æœ‰å”¯ä¸€çš„ç´¢å¼•/åˆ—æ—¶).
- ç³»åˆ—(å¦‚æœ1/'B'ä¹‹ä¸€åœ¨ç´¢å¼•/åˆ—ä¸­å¤šæ¬¡å‡ºç°).
- ä¸€ä¸ªæ•°æ®æ¡†(å¦‚æœåŒæ—¶åœ¨ç´¢å¼•/åˆ—ä¸­åŒæ—¶å‡ºç°'1/B').

locå’Œilocä¸­æœ‰å¾ˆå¤šè¾¹ç¼˜æƒ…å†µ,è§£å†³æ–¹æ¡ˆæ˜¯å°½å¯èƒ½æ˜ç¡®åœ°é¿å…å®ƒä»¬(åœ¨æ­¤å¤„ä½¿ç”¨).
å¦‚æ‚¨æ‰€çŸ¥,æ›´æ™®éåœ°,`é¿å…åœ¨DataFrameä¸­ä½¿ç”¨åˆ—è¡¨ï¼`

``` python
# http://www.cocoachina.com/articles/81838
# Correct
graph_t.loc[graph_t.rindex_0 == graph_t.rindex_1, ['v', 'shortest_path']] = [1, None]
# Error
graph_t.loc[graph_t.rindex_0 == graph_t.rindex_1, ['v', 'shortest_path']] = [1, {'path':None}]

```

### NOt use `predefined variables`

``` python
# é¿å…ä½¿ç”¨ä¿ç•™å­—æ®µ
# lines.loc[:, 'length'] = lines.geometry.apply(lambda x: coords_pair_dist(x.coords[0], x.coords[-1], xy=True))
lines.loc[:, '_len'] = lines.geometry.apply(lambda x: coords_pair_dist(x.coords[0], x.coords[-1], xy=True))
```
